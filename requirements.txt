import streamlit as st
import google.generativeai as genai
import datetime
import sqlite3
import json
import pandas as pd
import re
import time
import os

# --- 1. é é¢è¨­å®š (å¿…é ˆæ”¾ç¬¬ä¸€è¡Œ) ---
st.set_page_config(page_title="ä¿éšªæ¥­å‹™è¶…ç´šè»å¸«", page_icon="ğŸ›¡ï¸", layout="wide")

# --- 2. æ™ºæ…§å¼•å…¥ PDF å¥—ä»¶ (é˜²å´©æ½°æ©Ÿåˆ¶) ---
pdf_engine = None
pdf_error = ""
try:
    import pdfplumber
    pdf_engine = "pdfplumber"
except ImportError as e:
    pdf_error = str(e)
    try:
        from PyPDF2 import PdfReader
        pdf_engine = "pypdf2"
    except ImportError:
        pdf_engine = None

# --- ğŸ¨ é¢¨æ ¼è¨­å®š ---
st.markdown("""
<style>
    :root { --bg-main: #001222; --text-orange: #ff9933; --text-body: #e0e0e0; }
    .stApp { background-color: var(--bg-main); }
    .report-box { background-color: #ffffff !important; padding: 30px; border-radius: 8px; border-top: 8px solid var(--text-orange); margin-top: 20px; }
    .report-box * { color: #003366 !important; }
    .report-box h1, .report-box h2 { color: #002244 !important; border-bottom: 2px solid #ff9933; }
    .streamlit-expanderContent { background-color: #0d1b2a !important; padding: 15px; }
    .streamlit-expanderContent * { color: #e6f7ff !important; }
    #MainMenu, footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

# --- è³‡æ–™åº«åŸºç¤åŠŸèƒ½ (ç•¥ï¼Œä¿æŒä¸è®Š) ---
def init_db():
    conn = sqlite3.connect('insurance_crm.db')
    conn.execute('''CREATE TABLE IF NOT EXISTS clients (id INTEGER PRIMARY KEY AUTOINCREMENT, user_key TEXT, name TEXT, stage TEXT, data JSON, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    conn.close()

def save_client_to_db(user_key, name, stage, form_data):
    conn = sqlite3.connect('insurance_crm.db')
    json_data = json.dumps(form_data, default=str)
    conn.execute("INSERT INTO clients (user_key, name, stage, data) VALUES (?, ?, ?, ?) ON CONFLICT(id) DO UPDATE SET stage=excluded.stage, data=excluded.data", (user_key, name, stage, json_data))
    conn.commit()
    conn.close()

init_db()

# --- è‡ªå‹•è®€å–å¾Œå° PDF (ä¿®æ­£ç‰ˆ) ---
def load_kb():
    text, count = "", 0
    if not pdf_engine: return "", 0
    try:
        pdfs = [f for f in os.listdir('.') if f.lower().endswith('.pdf')]
        for f in pdfs:
            try:
                if pdf_engine == "pdfplumber":
                    with pdfplumber.open(f) as pdf:
                        text += "".join([p.extract_text() or "" for p in pdf.pages]) + "\n"
                else:
                    reader = PdfReader(f)
                    text += "".join([p.extract_text() or "" for p in reader.pages]) + "\n"
                count += 1
            except: continue
        return text, count
    except: return "", 0

if "kb_text" not in st.session_state:
    st.session_state.kb_text, st.session_state.kb_count = load_kb()

# --- å´é‚Šæ¬„ ---
with st.sidebar:
    st.markdown("### ğŸ—‚ï¸ å®¢æˆ¶ç®¡ç†")
    user_key = st.text_input("ğŸ”‘ å°ˆå±¬é‡‘é‘°", type="password")
    
    st.markdown("---")
    st.markdown("### ğŸ“š çŸ¥è­˜åº«ç‹€æ…‹")
    if st.session_state.kb_count > 0:
        st.success(f"âœ… å·²æ›è¼‰ {st.session_state.kb_count} ä»½æ‰‹å†Š")
    else:
        st.info("â„¹ï¸ æœªåµæ¸¬åˆ° PDF æ‰‹å†Š")
        if pdf_error: st.caption(f"åµæ¸¬ç•°å¸¸: {pdf_error}")

    st.markdown("---")
    st.markdown("### âš™ï¸ ç³»çµ±è¨­å®š")
    api_key = st.text_input("Google API Key", type="password")
    
    model = None
    sel_model = ""
    if api_key:
        genai.configure(api_key=api_key)
        try:
            m_list = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
            # å¼·åˆ¶è®“ 1.5-flash æ’ç¬¬ä¸€ä½
            m_list.sort(key=lambda x: "1.5-flash" not in x)
            sel_model = st.selectbox("ğŸ¤– é¸æ“‡ AI æ¨¡å‹", m_list, index=0)
            model = genai.GenerativeModel(sel_model)
            
            # --- â˜…â˜…â˜… é¡åº¦é è­¦é‚è¼¯ â˜…â˜…â˜… ---
            if "gemma" in sel_model.lower():
                st.warning("âš ï¸ Gemma æ¨¡å‹é¡åº¦æ¥µå°ï¼Œç³»çµ±å·²è‡ªå‹•åœç”¨æ‰‹å†Šè®€å–ä»¥é˜²å´©æ½°ã€‚")
                can_read_kb = False
            else:
                st.success("ğŸŸ¢ ç³»çµ±å·²é€£ç·š (æ”¯æ´æ‰‹å†Šè®€å–)")
                can_read_kb = True
        except: st.error("API Key é©—è­‰å¤±æ•—")

# --- ä¸»ç•«é¢é‚è¼¯ (ç°¡åŒ–ä»¥åˆ©ç©©å®š) ---
# (æ­¤è™•ä¿ç•™åŸæœ¬çš„è¡¨å–®ã€åˆ†æèˆ‡å°è©±é‚è¼¯ï¼Œä½†æ³¨å…¥çŸ¥è­˜åº«æ™‚åŠ å…¥ can_read_kb åˆ¤æ–·)

def generate_call(prompt_text):
    if not model: return "è«‹å…ˆè¨­å®š API Key"
    # æ™ºæ…§åˆ†æµï¼šåªæœ‰å¤§å®¹é‡æ¨¡å‹æ‰é¤µé£Ÿæ‰‹å†Š
    final_context = ""
    if can_read_kb and st.session_state.kb_text:
        # Flash çµ¦ 3è¬å­—ï¼Œå…¶ä»–çµ¦ 0
        final_context = f"\nã€å…¬å¸æ‰‹å†Šåƒè€ƒã€‘\n{st.session_state.kb_text[:30000]}\n"
    
    full_prompt = f"{final_context}\nä»»å‹™ï¼šä½ æ˜¯æ•™ç·´ Mars Changï¼Œè«‹åƒè€ƒä¸Šè¿°è³‡æ–™å›ç­”ï¼š\n{prompt_text}"
    
    try:
        res = model.generate_content(full_prompt)
        return res.text
    except Exception as e:
        return f"é€£ç·šç•°å¸¸: {str(e)}"

# --- UI å‰©é¤˜éƒ¨åˆ† (èˆ‡ä¹‹å‰ç‰ˆæœ¬ä¸€è‡´) ---
st.title("ğŸ›¡ï¸ ä¿éšªæ¥­å‹™è¶…ç´šè»å¸«")
# ... æ­¤è™•æ¥çºŒåŸæœ¬çš„è¡¨å–®èˆ‡å°è«‡é¡¯ç¤ºä»£ç¢¼ ...
st.info("ğŸ’¡ æç¤ºï¼šè‹¥é‡åˆ° 429 éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ [Google AI Studio Usage](https://aistudio.google.dev/app/plan_and_billing) ç¢ºèªé¡åº¦ã€‚")
